<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>InstaWall ‚Äì Uploader</title>
  <style>
    :root { --bg:#0b0d10; --card:#12161b; --accent:#6366f1; --muted:#9aa3af; }
    *{box-sizing:border-box}
    body{margin:0;font:16px/1.4 system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#fff;}
    .wrap{max-width:720px;margin:24px auto;padding:16px}
    h1{font-weight:700;font-size:22px;margin:0 0 12px}
    .card{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.3)}
    label{display:block;margin:10px 0 6px;color:#e5e7eb}
    input, textarea{width:100%;padding:12px;border-radius:12px;border:1px solid #2a313a;background:#0e1217;color:#fff}
    textarea{min-height:96px;resize:vertical}
    button{cursor:pointer;border:0;border-radius:14px;padding:12px 16px;font-weight:700}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .primary{background:var(--accent);color:#fff}
    .ghost{background:#19202a;color:#e5e7eb}
    .muted{color:var(--muted)}
    video,canvas,.preview{width:100%;aspect-ratio:3/4;background:#0e1217;border-radius:16px;object-fit:cover}
    .toast{position:fixed;inset:auto 16px 16px auto;background:#0b0d10;border:1px solid #2a313a;padding:12px 14px;border-radius:12px}
    .hide{display:none}
    .bar{display:flex;align-items:center;justify-content:flex-end;margin:10px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üì∏ InstaWall ‚Äì Post a Photo</h1>
    <div class="card">
      <!-- No Open Camera button ‚Äì only a fallback file picker -->
      <div class="bar">
        <label class="ghost" style="padding:12px 16px;cursor:pointer;">Choose File
          <input type="file" id="file" accept="image/*" capture="user" style="display:none" />
        </label>
      </div>

      <!-- Autostart camera preview -->
      <video id="video" playsinline muted class="hide"></video>
      <canvas id="canvas" class="hide"></canvas>
      <img id="preview" class="preview hide" alt="preview"/>

      <div class="row" style="margin-top:12px">
        <button id="capture" class="ghost">Capture Photo</button>
        <button id="retake" class="ghost hide">Retake</button>
      </div>

      <label>Username</label>
      <input id="username" placeholder="e.g. @alex" />

      <label>Comment</label>
      <textarea id="comment" placeholder="Say something nice‚Ä¶"></textarea>

      <div class="row" style="margin-top:10px">
        <button id="post" class="primary">Post</button>
        <span id="status" class="muted" aria-live="polite"></span>
      </div>
    </div>
  </div>

  <div id="toast" class="toast hide">Posting‚Ä¶</div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://ruljtbhgudrfocgwcnoe.supabase.co"; // ‚Üê replace
    const SUPABASE_ANON_KEY = "YOUR-ANON-KEY";               // ‚Üê replace
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const fileInput = document.getElementById('file');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const preview = document.getElementById('preview');
    const captureBtn = document.getElementById('capture');
    const retakeBtn = document.getElementById('retake');
    const username = document.getElementById('username');
    const comment = document.getElementById('comment');
    const postBtn = document.getElementById('post');
    const status = document.getElementById('status');
    const toast = document.getElementById('toast');

    let stream = null; let photoBlob = null; let photoType = 'image/jpeg';

    function showToast(msg){ toast.textContent = msg; toast.classList.remove('hide'); setTimeout(()=>toast.classList.add('hide'), 1800); }
    function show(el){ el.classList.remove('hide'); } function hide(el){ el.classList.add('hide'); }

    async function openCamera(){
      try {
        // prefer front camera for selfie flow; change to 'environment' if you want rear cam
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
        video.srcObject = stream;
        video.muted = true; // helps autoplay on some mobile browsers
        await video.play();
        show(video); hide(preview); hide(canvas); show(captureBtn); hide(retakeBtn);
      } catch (e) {
        console.warn('Camera unavailable:', e);
        // fallback: encourage file upload
        alert('Camera not available or permission denied. Use the file picker to upload a photo.');
      }
    }

    function dataURLtoBlob(dataUrl){
      const arr = dataUrl.split(','), mime = arr[0].match(/:(.*?);/)[1];
      const bstr = atob(arr[1]); let n = bstr.length; const u8 = new Uint8Array(n);
      while(n--){ u8[n] = bstr.charCodeAt(n); } return new Blob([u8], {type: mime});
    }

    captureBtn.onclick = () => {
      if(!video.srcObject){ return; }
      const w = 720; const h = Math.round(w / (3/4));
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, w, h);
      const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
      photoBlob = dataURLtoBlob(dataUrl); photoType = 'image/jpeg';
      preview.src = dataUrl; show(preview); hide(video); hide(canvas);
      hide(captureBtn); show(retakeBtn);
    };

    retakeBtn.onclick = () => { photoBlob = null; openCamera(); };

    fileInput.onchange = (e) => {
      const file = e.target.files[0]; if(!file) return;
      photoBlob = file; photoType = file.type || 'image/jpeg';
      const reader = new FileReader();
      reader.onload = () => { preview.src = reader.result; show(preview); hide(video); hide(canvas); hide(captureBtn); show(retakeBtn); };
      reader.readAsDataURL(file);
    };

    async function uploadPhoto(blob){
      const filename = `${Date.now()}_${Math.random().toString(36).slice(2)}.jpg`;
      const { error: upErr } = await supabase.storage.from('photos').upload(filename, blob, {
        cacheControl: '3600', upsert: false, contentType: photoType
      });
      if(upErr) throw upErr;
      const { data } = supabase.storage.from('photos').getPublicUrl(filename);
      return data.publicUrl;
    }

    postBtn.onclick = async () => {
      if(!photoBlob){ alert('Capture or choose a photo first.'); return; }
      const name = username.value.trim() || '@guest';
      const text = comment.value.trim();
      if(!text){ alert('Please write a comment.'); return; }
      postBtn.disabled = true; status.textContent = 'Uploading‚Ä¶'; showToast('Posting‚Ä¶');
      try {
        const image_url = await uploadPhoto(photoBlob);
        const { error: dbErr } = await supabase.from('posts').insert({ username: name, comment: text, image_url });
        if(dbErr) throw dbErr;
        status.textContent = '‚úÖ Posted!'; showToast('‚úÖ Posted');
        comment.value = ''; photoBlob = null; preview.src = ''; hide(preview); show(video); hide(retakeBtn); show(captureBtn);
      } catch(err){
        console.error(err); status.textContent = '‚ùå Failed to post'; alert('Failed to post: '+ err.message);
      } finally { postBtn.disabled = false; }
    };

    // üî• Auto-open camera on load
    document.addEventListener('DOMContentLoaded', openCamera);
  </script>
</body>
</html>

