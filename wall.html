<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>InstaWall – Live Wall</title>
  <style>
    :root{ --bg:#06080a; --card:#0c1116; --muted:#9aa3af; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font:16px/1.45 system-ui,Segoe UI,Roboto,Arial;color:#fff;overflow:hidden}
    .grid{position:fixed;inset:0;padding:18px;display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:18px;align-content:start}
    .card{background:var(--card);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.35);overflow:hidden;animation:float var(--dur) ease-in-out infinite alternate;transform:translateY(0)}
    .head{display:flex;gap:8px;align-items:center;padding:10px 12px}
    .avatar{width:28px;height:28px;border-radius:50%;background:#141a20}
    .user{font-weight:700;font-size:14px}
    .img{width:100%;aspect-ratio:3/4;object-fit:cover;background:#0e1217}
    .body{padding:10px 12px;color:#e5e7eb}
    .muted{color:var(--muted);font-size:12px}
    @keyframes float { to { transform: translateY(-8px); } }
    .toast{position:fixed;left:50%;top:14px;transform:translateX(-50%);background:#0b0d10;border:1px solid #2a313a;padding:10px 14px;border-radius:12px;opacity:0;transition:opacity .25s, transform .25s;display:flex;gap:10px;align-items:center}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(6px)}
    .toast img{width:38px;height:38px;border-radius:8px;object-fit:cover}
    .badge{position:fixed;right:12px;bottom:12px;background:#0b0d10;border:1px solid #2a313a;padding:6px 10px;border-radius:10px;color:#9aa3af;font-size:12px}
  </style>
</head>
<body>
  <div id="grid" class="grid"></div>
  <div id="badge" class="badge">Connecting…</div>
  <div id="toast" class="toast">
    <img id="timg" alt=""/>
    <div>
      <div id="tuser" style="font-weight:700"></div>
      <div id="ttext" class="muted"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
      const SUPABASE_URL = "https://ruljtbhgudrfocgwcnoe.supabase.co"; // ← replace
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1bGp0YmhndWRyZm9jZ3djbm9lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MDE5OTEsImV4cCI6MjA3NTM3Nzk5MX0.QAbmN26benW_dolUKPtWx-oOylwIRjYvvlSoTx-U_bk";               // ← replace
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const grid = document.getElementById('grid');
    const toast = document.getElementById('toast');
    const timg = document.getElementById('timg');
    const tuser = document.getElementById('tuser');
    const ttext = document.getElementById('ttext');
    const badge = document.getElementById('badge');

    function card(post){
      const div = document.createElement('div'); div.className = 'card';
      div.style.setProperty('--dur', (6 + Math.random()*8)+'s');
      div.innerHTML = `
        <div class="head">
          <div class="avatar"></div>
          <div class="user">${escapeHtml(post.username)}</div>
        </div>
        <img class="img" src="${post.image_url}" alt="photo by ${escapeHtml(post.username)}"/>
        <div class="body">
          <div>${linkify(escapeHtml(post.comment))}</div>
          <div class="muted">${new Date(post.created_at).toLocaleString()}</div>
        </div>`;
      return div;
    }

    function escapeHtml(s){ return s?.replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) || ''; }
    function linkify(text){ return text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>'); }

    async function loadInitial(){
      const { data, error } = await supabase.from('posts').select('*').eq('approved', true).order('created_at', { ascending: false }).limit(100);
      if(error){ console.error(error); return; }
      grid.innerHTML = '';
      data.forEach(p => grid.appendChild(card(p)));
    }

    function showToast(p){
      timg.src = p.image_url; tuser.textContent = p.username; ttext.textContent = p.comment;
      toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 2200);
    }

    function subscribeRealtime(){
      const channel = supabase
        .channel('posts-changes')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'posts' }, payload => {
          const p = payload.new; if(!p.approved) return;
          grid.prepend(card(p)); showToast(p);
        })
        .subscribe((status) => { badge.textContent = status === 'SUBSCRIBED' ? 'Connected' : status; });
    }

    loadInitial();
    subscribeRealtime();
  </script>
</body>
</html>
